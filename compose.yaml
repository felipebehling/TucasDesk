# services:
#   db:
#     image: mariadb:11.4
#     container_name: tucasdesk-db
#     restart: unless-stopped
#     env_file:
#       - ./.env
#     environment:
#       TZ: America/Sao_Paulo
#       MARIADB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
#       MARIADB_DATABASE: ${DB_NAME}
#       MARIADB_USER: ${DB_USER}
#       MARIADB_PASSWORD: ${DB_PASSWORD}
#       MARIADB_CHARACTER_SET_SERVER: utf8mb4
#       MARIADB_COLLATION_SERVER: utf8mb4_unicode_ci
#     ports:
#       - "3307:3306" # host:container – container SEM usar variável
#     volumes:
#       - database-data:/var/lib/mysql
#       - ./infra/docker/mysql-init:/docker-entrypoint-initdb.d
#     healthcheck:
#       test: ["CMD", "mariadb-admin", "ping", "-h", "localhost", "-u", "tucasdesk", "-p${DB_PASSWORD}", "--silent"]
#       interval: 10s
#       timeout: 5s
#       retries: 10
#       start_period: 40s
#     logging:
#       driver: json-file
#       options:
#         max-size: "10m"
#         max-file: "3"

#   backend:
#     build: ./apps/backend
#     container_name: tucasdesk-backend
#     restart: unless-stopped
#     depends_on:
#       db:
#         condition: service_healthy
#     environment:
#       TZ: America/Sao_Paulo
#       SPRING_PROFILES_ACTIVE: mariadb,docker
#       # COMUNICAÇÃO INTERNA ENTRE CONTAINERS USA PORTA 3306 FIXA
#       SPRING_DATASOURCE_URL: jdbc:mariadb://db:3306/${DB_NAME}?useSSL=false&allowPublicKeyRetrieval=true&useUnicode=true&characterEncoding=utf8
#       SPRING_DATASOURCE_USERNAME: ${DB_USER}
#       SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
#       DATABASE_URL: mariadb://${DB_USER}:${DB_PASSWORD}@db:3306/${DB_NAME}
#       AWS_COGNITO_REGION: ${AWS_COGNITO_REGION}
#       AWS_COGNITO_USER_POOL_ID: ${AWS_COGNITO_USER_POOL_ID}
#       AWS_COGNITO_APP_CLIENT_ID: ${AWS_COGNITO_APP_CLIENT_ID}
#       AWS_COGNITO_ISSUER_URI: ${AWS_COGNITO_ISSUER_URI}
#       AWS_COGNITO_JWK_SET_URI: ${AWS_COGNITO_JWK_SET_URI}
#       SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: 10
#       SPRING_DATASOURCE_HIKARI_CONNECTION_TIMEOUT: 20000
#       SPRING_JPA_OPEN_IN_VIEW: "false"
#     ports:
#       - "8080:8080"
#     healthcheck:
#       test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/actuator/health"]
#       interval: 30s
#       timeout: 5s
#       retries: 5
#       start_period: 30s
#     logging:
#       driver: json-file
#       options:
#         max-size: "10m"
#         max-file: "3"

#   frontend:
#     build:
#       context: ./apps/frontend
#       args:
#         VITE_API_URL: ${VITE_API_URL}
#     container_name: tucasdesk-frontend
#     restart: unless-stopped
#     environment:
#       TZ: America/Sao_Paulo
#       VITE_API_URL: ${VITE_API_URL}
#     ports:
#       - "3000:80"
#     depends_on:
#       - backend
#     logging:
#       driver: json-file
#       options:
#         max-size: "10m"
#         max-file: "3"

# volumes:
#   database-data:








version: "3.9"

services:
  db:
    image: mariadb:11.4
    container_name: tucasdesk-db
    restart: unless-stopped
    env_file:
      - ./.env
    environment:
      TZ: America/Sao_Paulo
      MARIADB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MARIADB_DATABASE: ${DB_NAME}
      MARIADB_USER: ${DB_USER}
      MARIADB_PASSWORD: ${DB_PASSWORD}
      MARIADB_CHARACTER_SET_SERVER: utf8mb4
      MARIADB_COLLATION_SERVER: utf8mb4_unicode_ci
    ports:
      - "3307:3306"
    volumes:
      - database-data:/var/lib/mysql
      - ./infra/docker/mysql-init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD", "mariadb-admin", "ping", "-h", "localhost", "-uroot", "-p${DB_ROOT_PASSWORD}", "--silent"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - tucasdesk-net

  localstack:
    container_name: tucasdesk-localstack
    image: localstack/localstack:3.5.0
    ports:
      - "4566:4566"
    environment:
      - SERVICES=cognito-idp,sqs,ses,sns
      - DEBUG=1
      - DEFAULT_REGION=${AWS_REGION}
      - AWS_DEFAULT_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
    volumes:
      - ./infra/localstack:/etc/localstack/init/ready.d
      - localstack-sync:/tmp/localstack
    networks:
      - tucasdesk-net
    healthcheck:
      test: ["CMD", "test", "-f", "/tmp/localstack/initialized"]
      interval: 5s
      timeout: 2s
      retries: 20

  backend-1:
    build: ./apps/backend
    container_name: tucasdesk-backend-1
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      localstack:
        condition: service_healthy
    env_file:
      - ./.env
    volumes:
      - localstack-sync:/tmp/localstack
    environment:
      TZ: America/Sao_Paulo
      INSTANCE_ID: 1
      APP_CLUSTER_SIZE: 2
      SPRING_PROFILES_ACTIVE: mariadb,docker,localstack
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL}
      SPRING_DATASOURCE_USERNAME: ${SPRING_DATASOURCE_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${SPRING_DATASOURCE_PASSWORD}
      DATABASE_URL: ${DATABASE_URL}
      APP_CORS_ALLOWED_ORIGINS: ${APP_CORS_ALLOWED_ORIGINS}
      AWS_COGNITO_REGION: ${AWS_COGNITO_REGION}
      AWS_COGNITO_USER_POOL_ID: ${AWS_COGNITO_USER_POOL_ID}
      AWS_COGNITO_APP_CLIENT_ID: ${AWS_COGNITO_APP_CLIENT_ID}
      AWS_COGNITO_ISSUER_URI: ${AWS_COGNITO_ISSUER_URI}
      AWS_COGNITO_JWK_SET_URI: ${AWS_COGNITO_JWK_SET_URI}
      AWS_REGION: ${AWS_REGION}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_SQS_QUEUE_NAME: ${AWS_SQS_QUEUE_NAME}
      AWS_SNS_TOPIC_ARN: ${AWS_SNS_TOPIC_ARN}
      AWS_SNS_TICKET_CREATED_TOPIC_ARN: ${AWS_SNS_TICKET_CREATED_TOPIC_ARN}
      AWS_SNS_TICKET_CLOSED_TOPIC_ARN: ${AWS_SNS_TICKET_CLOSED_TOPIC_ARN}
      AWS_SNS_TICKET_INTERACTED_TOPIC_ARN: ${AWS_SNS_TICKET_INTERACTED_TOPIC_ARN}
      AWS_SES_ENABLED: ${AWS_SES_ENABLED}
      AWS_SES_REGION: ${AWS_SES_REGION}
      AWS_SES_FROM_ADDRESS: ${AWS_SES_FROM_ADDRESS}
      AWS_SES_REPLY_TO_ADDRESS: ${AWS_SES_REPLY_TO_ADDRESS}
      AWS_SES_TO_ADDRESSES: ${AWS_SES_TO_ADDRESSES}
      AWS_SES_TEMPLATE_NAME: ${AWS_SES_TEMPLATE_NAME}
      AWS_SES_CONFIGURATION_SET: ${AWS_SES_CONFIGURATION_SET}
    ports:
      - "8081:8080"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - tucasdesk-net

  backend-2:
    build: ./apps/backend
    container_name: tucasdesk-backend-2
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      localstack:
        condition: service_healthy
    env_file:
      - ./.env
    volumes:
      - localstack-sync:/tmp/localstack
    environment:
      TZ: America/Sao_Paulo
      INSTANCE_ID: 2
      APP_CLUSTER_SIZE: 2
      SPRING_PROFILES_ACTIVE: mariadb,docker,localstack
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL}
      SPRING_DATASOURCE_USERNAME: ${SPRING_DATASOURCE_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${SPRING_DATASOURCE_PASSWORD}
      DATABASE_URL: ${DATABASE_URL}
      APP_CORS_ALLOWED_ORIGINS: ${APP_CORS_ALLOWED_ORIGINS}
      AWS_COGNITO_REGION: ${AWS_COGNITO_REGION}
      AWS_COGNITO_USER_POOL_ID: ${AWS_COGNITO_USER_POOL_ID}
      AWS_COGNITO_APP_CLIENT_ID: ${AWS_COGNITO_APP_CLIENT_ID}
      AWS_COGNITO_ISSUER_URI: ${AWS_COGNITO_ISSUER_URI}
      AWS_COGNITO_JWK_SET_URI: ${AWS_COGNITO_JWK_SET_URI}
      AWS_REGION: ${AWS_REGION}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_SQS_QUEUE_NAME: ${AWS_SQS_QUEUE_NAME}
      AWS_SNS_TOPIC_ARN: ${AWS_SNS_TOPIC_ARN}
      AWS_SNS_TICKET_CREATED_TOPIC_ARN: ${AWS_SNS_TICKET_CREATED_TOPIC_ARN}
      AWS_SNS_TICKET_CLOSED_TOPIC_ARN: ${AWS_SNS_TICKET_CLOSED_TOPIC_ARN}
      AWS_SNS_TICKET_INTERACTED_TOPIC_ARN: ${AWS_SNS_TICKET_INTERACTED_TOPIC_ARN}
      AWS_SES_ENABLED: ${AWS_SES_ENABLED}
      AWS_SES_REGION: ${AWS_SES_REGION}
      AWS_SES_FROM_ADDRESS: ${AWS_SES_FROM_ADDRESS}
      AWS_SES_REPLY_TO_ADDRESS: ${AWS_SES_REPLY_TO_ADDRESS}
      AWS_SES_TO_ADDRESSES: ${AWS_SES_TO_ADDRESSES}
      AWS_SES_TEMPLATE_NAME: ${AWS_SES_TEMPLATE_NAME}
      AWS_SES_CONFIGURATION_SET: ${AWS_SES_CONFIGURATION_SET}
    ports:
      - "8082:8080"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - tucasdesk-net

  frontend:
    build:
      context: ./apps/frontend
      args:
        VITE_API_URL: ${VITE_API_URL}
    container_name: tucasdesk-frontend
    restart: unless-stopped
    env_file:
      - ./.env
    volumes:
      - localstack-sync:/tmp/localstack
    environment:
      TZ: America/Sao_Paulo
      VITE_API_URL: ${VITE_API_URL}
    ports:
      - "3000:80"
    depends_on:
      - backend-1
      - backend-2
      - localstack
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - tucasdesk-net

volumes:
  database-data:
  localstack-sync:

networks:
  tucasdesk-net:
